#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_12__   TYPE_6__ ;
typedef  struct TYPE_11__   TYPE_5__ ;
typedef  struct TYPE_10__   TYPE_4__ ;
typedef  struct TYPE_9__   TYPE_3__ ;
typedef  struct TYPE_8__   TYPE_2__ ;
typedef  struct TYPE_7__   TYPE_1__ ;

/* Type definitions */
typedef  int /*<<< orphan*/  special_port_msg ;
struct TYPE_12__ {int /*<<< orphan*/  msgh_bits; int /*<<< orphan*/  msgh_remote_port; } ;
struct TYPE_9__ {TYPE_6__ header; int /*<<< orphan*/  member_0; } ;
typedef  TYPE_3__ simple_msg_rcv_t ;
struct TYPE_11__ {int msgh_size; int msgh_bits; int /*<<< orphan*/  msgh_remote_port; int /*<<< orphan*/  msgh_local_port; } ;
struct TYPE_8__ {int /*<<< orphan*/  type; int /*<<< orphan*/  disposition; int /*<<< orphan*/  name; } ;
struct TYPE_7__ {int msgh_descriptor_count; } ;
struct TYPE_10__ {TYPE_5__ header; TYPE_2__ port; TYPE_1__ body; int /*<<< orphan*/  member_0; } ;
typedef  TYPE_4__ port_msg_send_t ;
typedef  int /*<<< orphan*/  msg ;
typedef  int /*<<< orphan*/  mach_port_t ;
typedef  int /*<<< orphan*/  kern_return_t ;

/* Variables and functions */
 int /*<<< orphan*/  LOG (char*) ; 
 int /*<<< orphan*/  MACH_ERR (char*,int /*<<< orphan*/ ) ; 
 int MACH_MSGH_BITS (int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int MACH_MSGH_BITS_COMPLEX ; 
 int /*<<< orphan*/  MACH_MSGH_BITS_REMOTE (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  MACH_MSG_PORT_DESCRIPTOR ; 
 int /*<<< orphan*/  MACH_MSG_TIMEOUT_NONE ; 
 int /*<<< orphan*/  MACH_MSG_TYPE_COPY_SEND ; 
 int /*<<< orphan*/  MACH_PORT_NULL ; 
 int /*<<< orphan*/  MACH_RCV_MSG ; 
 int /*<<< orphan*/  STOLEN_SPECIAL_PORT ; 
 int /*<<< orphan*/  mach_msg (TYPE_6__*,int /*<<< orphan*/ ,int /*<<< orphan*/ ,int,int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  mach_msg_send (TYPE_5__*) ; 
 int /*<<< orphan*/  mach_task_self () ; 
 int /*<<< orphan*/  saved_special_port ; 
 int /*<<< orphan*/  shared_port_parent ; 
 int /*<<< orphan*/  task_set_special_port (int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 

mach_port_t recover_shared_port_parent() {
  kern_return_t err;

  // restore the special port for ourselves
  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, saved_special_port);
  MACH_ERR("parent restoring special port", err);

  // wait for a message from the child on the shared port
  simple_msg_rcv_t msg = {0};
  err = mach_msg(&msg.header,
                 MACH_RCV_MSG,
                 0,
                 sizeof(msg),
                 shared_port_parent,
                 MACH_MSG_TIMEOUT_NONE,
                 MACH_PORT_NULL);
  MACH_ERR("parent receiving child hello message", err);

  LOG("parent received hello message from child");

  // send the special port to our child over the hello message's reply port
  port_msg_send_t special_port_msg = {0};

  special_port_msg.header.msgh_size        = sizeof(special_port_msg);
  special_port_msg.header.msgh_local_port  = MACH_PORT_NULL;
  special_port_msg.header.msgh_remote_port = msg.header.msgh_remote_port;
  special_port_msg.header.msgh_bits        = MACH_MSGH_BITS(MACH_MSGH_BITS_REMOTE(msg.header.msgh_bits), 0) | MACH_MSGH_BITS_COMPLEX;
  special_port_msg.body.msgh_descriptor_count = 1;

  special_port_msg.port.name        = saved_special_port;
  special_port_msg.port.disposition = MACH_MSG_TYPE_COPY_SEND;
  special_port_msg.port.type        = MACH_MSG_PORT_DESCRIPTOR;

  err = mach_msg_send(&special_port_msg.header);
  MACH_ERR("parent sending special port back to child", err);

  return shared_port_parent;
}